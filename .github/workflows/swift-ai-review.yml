name: AI Code Review (Swift)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      # 1. Repo checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. PR diff al
      - name: Fetch PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }} > diff.txt

      # 3. Python + OpenAI SDK install
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install openai

      # 4. ChatGPT Swift Review Ã§alÄ±ÅŸtÄ±r
      - name: Run ChatGPT Swift Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 - <<'EOF'
          import os
          from openai import OpenAI

          # OpenAI Client
          client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

          # Diff oku
          with open("diff.txt", "r") as f:
              diff = f.read()

          # Diff Ã§ok bÃ¼yÃ¼kse truncate et
          max_chars = 12000
          if len(diff) > max_chars:
              diff = diff[:max_chars] + "\n\n...[TRUNCATED]..."

          # Swift odaklÄ± prompt
          prompt = f"""
          You are a senior iOS engineer specializing in Swift, UIKit, and SwiftUI.

          Review this GitHub Pull Request diff.

          Focus on:
          - crashes and runtime bugs
          - SwiftUI state management issues
          - UIKit lifecycle mistakes
          - memory leaks (retain cycles, closures)
          - async/await and concurrency problems
          - performance issues (layout, rendering)
          - maintainability and best practices
          - missing tests

          Return feedback grouped by severity:

          Critical:
          Major:
          Minor:

          Diff:
          {diff}
          """

          # OpenAI Chat Completion
          response = client.chat.completions.create(
              model="gpt-4o",
              messages=[
                  {"role": "user", "content": prompt}
              ]
          )

          review = response.choices[0].message.content

          print("\n===== AI REVIEW OUTPUT =====\n")
          print(review)

          # Review dosyasÄ±na yaz
          with open("review.md", "w") as f:
              f.write("# ðŸ¤– Swift AI Code Review\n\n")
              f.write(review)

          EOF

      # 5. Review artifact upload et
      - name: Upload Review Artifact
        uses: actions/upload-artifact@v4
        with:
          name: swift-ai-review
          path: review.md

      # 6. (Opsiyonel) PRâ€™a otomatik yorum bÄ±rakmak istersen aÃ§
      # - name: Comment AI Review on PR
      #   uses: peter-evans/create-or-update-comment@v3
      #   with:
      #     issue-number: ${{ github.event.pull_request.number }}
      #     body: |
      #       ## ðŸ¤– Swift AI Code Review Completed
      #
      #       Review artifact is available in Actions â†’ swift-ai-review â†’ review.md
